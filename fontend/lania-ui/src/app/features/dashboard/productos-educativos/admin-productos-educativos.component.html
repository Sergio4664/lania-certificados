<div class="module-content">
  <div class="module-header">
    <h2>Gesti√≥n de Productos Educativos</h2>
    <div class="header-actions">
      <div class="search-container">
        <label for="search-producto" class="visually-hidden"></label>
        <input
          type="text"
          id="search-producto"
          name="search-producto"
          [(ngModel)]="searchTerm"
          (input)="groupAndFilterProducts()"
          placeholder="Buscar por nombre..."
          autocomplete="off"
        >
        <svg class="search-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="11" cy="11" r="8"></circle>
          <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
        </svg>
      </div>
      
      <!-- üéØ BOT√ìN A√ëADIDO PARA LA DESCARGA DE PLANTILLA -->
      <button class="secondary-btn download-template-btn" (click)="downloadTemplate()" title="Descargar plantilla CSV para carga masiva">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
            <polyline points="7 10 12 15 17 10"></polyline>
            <line x1="12" y1="15" x2="12" y2="3"></line>
        </svg>
        Plantilla CSV
      </button>

      <button class="primary-btn" (click)="resetCourseForm(); showCourseForm = true">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
        Nuevo Producto Educativo
      </button>
    </div>
  </div>

  <div *ngIf="showCourseForm" class="form-card">
    <h3>{{ editingCourse ? 'Editar el Producto Educativo' : 'Crear Nuevo Producto Educativo' }}</h3>
    <form [formGroup]="courseForm" (ngSubmit)="onSubmitCourse()" class="form-grid">

      <div class="form-group">
        <label for="producto-nombre">Nombre del Producto</label>
        <input id="producto-nombre" name="producto-nombre" formControlName="nombre" required autocomplete="off">
      </div>

      <div class="form-group">
        <label for="producto-horas">Horas</label>
        <input id="producto-horas" name="producto-horas" type="number" formControlName="horas" required autocomplete="off">
      </div>

      <div class="form-group">
        <label for="producto-fecha-inicio">Fecha de Inicio</label>
        <input id="producto-fecha-inicio" name="producto-fecha-inicio" type="date" formControlName="fecha_inicio" required autocomplete="off">
      </div>

      <div class="form-group">
        <label for="producto-fecha-fin">Fecha de Fin</label>
        <input id="producto-fecha-fin" name="producto-fecha-fin" type="date" formControlName="fecha_fin" required autocomplete="off">
      </div>

      <div *ngIf="courseForm.hasError('dateRangeInvalid') && (courseForm.get('fecha_fin')?.touched || courseForm.get('fecha_inicio')?.touched)" class="form-error full-width">
        <p>Error: La fecha de finalizaci√≥n no puede ser anterior a la fecha de inicio.</p>
      </div>

      <div class="form-group">
        <label for="producto-tipo">Tipo de Producto</label>
        <select id="producto-tipo" name="producto-tipo" formControlName="tipo_producto" required>
          <option value="INYECCION_EDUCATIVA">Inyecci√≥n Educativa</option>
          <option value="PILDORA_EDUCATIVA">P√≠ldora Educativa</option>
          <option value="CURSO_EDUCATIVO">Curso Educativo</option>
        </select>
      </div>

      <div class="form-group">
        <label for="producto-modalidad">Modalidad</label>
        <select id="producto-modalidad" name="producto-modalidad" formControlName="modalidad" required>
          <option value="REMOTA">Remota</option>
          <option value="PRESENCIAL">Presencial</option>
          <option value="HIBRIDA">H√≠brida</option>
          <option value="SABATINA">Sabatina</option>
          <option value="ESCOLARIZADA">Escolarizada</option>
        </select>
      </div>

      <div class="form-group full-width" *ngIf="courseForm.get('tipo_producto')?.value === 'CURSO_EDUCATIVO'">
        <label>Competencias del Curso</label>
        <button type="button" class="secondary-btn icon-left" (click)="openCompetenciesModal()">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
          {{ courseForm.get('competencias')?.value ? 'Editar Competencias' : 'A√±adir Competencias' }}
        </button>
      </div>

      <div class="form-group full-width">
        <label>Docentes Asignados</label>
        <div class="docentes-selection">
          <div class="docentes-checkboxes">
            <div class="checkbox-item" *ngFor="let docente of docentes">
              <input type="checkbox"
                     [id]="'docente-' + docente.id"
                     [checked]="isDocenteSelected(docente.id)"
                     (change)="toggleDocenteSelection(docente.id, $event)">
              <label [for]="'docente-' + docente.id">
                <strong *ngIf="docente.especialidad" style="color: #667eea; display: block; font-size: 0.9em; margin-bottom: 2px;">{{docente.especialidad}}</strong>
                {{docente.nombre_completo}}
                <small>({{docente.email_institucional}})</small>
              </label>
            </div>
          </div>
        </div>
        
        <div *ngIf="courseForm.get('docentes_ids')?.hasError('minLength') && (courseForm.get('docentes_ids')?.touched || courseForm.get('docentes_ids')?.dirty)" class="form-error">
          <p>Debe seleccionar al menos un docente.</p>
        </div>
      </div>

      <div class="form-actions">
        <button type="button" class="secondary-btn" (click)="cancelCourseForm()">Cancelar</button>
        <button type="submit" class="primary-btn" [disabled]="courseForm.invalid">{{ editingCourse ? 'Actualizar Producto' : 'Crear Producto' }}</button>
      </div>
    </form>
  </div>
  
  <!-- ========================================= -->
  <!-- SECCI√ìN: CURSOS EDUCATIVOS CON PAGINACI√ìN -->
  <!-- ========================================= -->
  <div class="product-section">
    <div class="section-header">
      <h3 class="section-title">Cursos Educativos</h3>
      
      <!-- ‚úÖ Controles de paginaci√≥n para Cursos -->
      <div class="pagination-controls" *ngIf="cursos.length > 0">
        <button 
          class="btn btn-secondary btn-pagination" 
          (click)="prevPageCursos()" 
          [disabled]="cursosPage === 0">
          ‚Üê Atr√°s
        </button>
        
        <span class="page-info">
          P√°gina {{ cursosPage + 1 }} de {{ Math.ceil(cursos.length / ITEMS_PER_PAGE) }}
        </span>
        
        <button 
          class="btn btn-secondary btn-pagination" 
          (click)="nextPageCursos()" 
          [disabled]="!hasMoreCursos">
          Siguiente ‚Üí
        </button>
      </div>
    </div>

    <div class="courses-grid">
      <div class="course-card" *ngFor="let producto of cursosPaginados" (click)="selectCourse(producto)">
        <div class="course-card-header" [style.backgroundColor]="getCourseColor(producto.id)">
          <h3 class="course-name">{{ producto.nombre }}</h3>
        </div>
        <div class="course-card-body">
          <div class="detail-item"><strong>Modalidad:</strong> {{ producto.modalidad | uppercase }}</div>
          <div class="detail-item"><strong>Fechas:</strong> {{ producto.fecha_inicio | date:'dd/MM/yy' }} - {{ producto.fecha_fin | date:'dd/MM/yy' }}</div>
          <div class="detail-item"><strong>Horas:</strong> {{ producto.horas }}h</div>
          <div class="detail-item docentes"><strong>Docente(s):</strong>
            <div *ngIf="producto.docentes && producto.docentes.length > 0; else noDocentesCurso" class="docentes-list">
              <span *ngFor="let docente of producto.docentes" class="docente-tag-small">
                <strong *ngIf="docente.especialidad">{{ docente.especialidad }}:</strong> {{ docente.nombre_completo }}
              </span>
            </div>
            <ng-template #noDocentesCurso><span class="no-docentes-small">No asignados</span></ng-template>
          </div>
        </div>
        <div class="course-card-footer">
          <button class="icon-btn-card edit" (click)="editCourse(producto); $event.stopPropagation()" title="Editar">‚úèÔ∏è</button>
          <button class="icon-btn-card delete" (click)="deleteCourse(producto.id); $event.stopPropagation()" title="Eliminar">üóëÔ∏è</button>
        </div>
      </div>
    </div>
    
    <div *ngIf="cursos.length === 0" class="no-data-card">
      {{ searchTerm ? 'No se encontraron cursos que coincidan con la b√∫squeda.' : 'No hay cursos registrados.' }}
    </div>
  </div>

  <!-- ========================================= -->
  <!-- SECCI√ìN: P√çLDORAS EDUCATIVAS CON PAGINACI√ìN -->
  <!-- ========================================= -->
  <div class="product-section">
    <div class="section-header">
      <h3 class="section-title">P√≠ldoras Educativas</h3>
      
      <!-- ‚úÖ Controles de paginaci√≥n para P√≠ldoras -->
      <div class="pagination-controls" *ngIf="pildoras.length > 0">
        <button 
          class="btn btn-secondary btn-pagination" 
          (click)="prevPagePildoras()" 
          [disabled]="pildorasPage === 0">
          ‚Üê Atr√°s
        </button>
        
        <span class="page-info">
          P√°gina {{ pildorasPage + 1 }} de {{ Math.ceil(pildoras.length / ITEMS_PER_PAGE) }}
        </span>
        
        <button 
          class="btn btn-secondary btn-pagination" 
          (click)="nextPagePildoras()" 
          [disabled]="!hasMorePildoras">
          Siguiente ‚Üí
        </button>
      </div>
    </div>

    <div class="courses-grid">
      <div class="course-card" *ngFor="let producto of pildorasPaginadas" (click)="selectCourse(producto)">
        <div class="course-card-header" [style.backgroundColor]="getCourseColor(producto.id)">
          <h3 class="course-name">{{ producto.nombre }}</h3>
        </div>
        <div class="course-card-body">
          <div class="detail-item"><strong>Modalidad:</strong> {{ producto.modalidad | uppercase }}</div>
          <div class="detail-item"><strong>Fechas:</strong> {{ producto.fecha_inicio | date:'dd/MM/yy' }} - {{ producto.fecha_fin | date:'dd/MM/yy' }}</div>
          <div class="detail-item"><strong>Horas:</strong> {{ producto.horas }}h</div>
          <div class="detail-item docentes"><strong>Docente(s):</strong>
            <div *ngIf="producto.docentes && producto.docentes.length > 0; else noDocentesPildora" class="docentes-list">
              <span *ngFor="let docente of producto.docentes" class="docente-tag-small">
                <strong *ngIf="docente.especialidad">{{ docente.especialidad }}:</strong> {{ docente.nombre_completo }}
              </span>
            </div>
            <ng-template #noDocentesPildora><span class="no-docentes-small">No asignados</span></ng-template>
          </div>
        </div>
        <div class="course-card-footer">
          <button class="icon-btn-card edit" (click)="editCourse(producto); $event.stopPropagation()" title="Editar">‚úèÔ∏è</button>
          <button class="icon-btn-card delete" (click)="deleteCourse(producto.id); $event.stopPropagation()" title="Eliminar">üóëÔ∏è</button>
        </div>
      </div>
    </div>
    
    <div *ngIf="pildoras.length === 0" class="no-data-card">
      {{ searchTerm ? 'No se encontraron p√≠ldoras.' : 'No hay p√≠ldoras registradas.' }}
    </div>
  </div>

  <!-- ========================================= -->
  <!-- SECCI√ìN: INYECCIONES EDUCATIVAS CON PAGINACI√ìN -->
  <!-- ========================================= -->
  <div class="product-section">
    <div class="section-header">
      <h3 class="section-title">Inyecciones Educativas</h3>
      
      <!-- ‚úÖ Controles de paginaci√≥n para Inyecciones -->
      <div class="pagination-controls" *ngIf="inyecciones.length > 0">
        <button 
          class="btn btn-secondary btn-pagination" 
          (click)="prevPageInyecciones()" 
          [disabled]="inyeccionesPage === 0">
          ‚Üê Atr√°s
        </button>
        
        <span class="page-info">
          P√°gina {{ inyeccionesPage + 1 }} de {{ Math.ceil(inyecciones.length / ITEMS_PER_PAGE) }}
        </span>
        
        <button 
          class="btn btn-secondary btn-pagination" 
          (click)="nextPageInyecciones()" 
          [disabled]="!hasMoreInyecciones">
          Siguiente ‚Üí
        </button>
      </div>
    </div>

    <div class="courses-grid">
      <div class="course-card" *ngFor="let producto of inyeccionesPaginadas" (click)="selectCourse(producto)">
        <div class="course-card-header" [style.backgroundColor]="getCourseColor(producto.id)">
          <h3 class="course-name">{{ producto.nombre }}</h3>
        </div>
        <div class="course-card-body">
          <div class="detail-item"><strong>Modalidad:</strong> {{ producto.modalidad | uppercase }}</div>
          <div class="detail-item"><strong>Fechas:</strong> {{ producto.fecha_inicio | date:'dd/MM/yy' }} - {{ producto.fecha_fin | date:'dd/MM/yy' }}</div>
          <div class="detail-item"><strong>Horas:</strong> {{ producto.horas }}h</div>
          <div class="detail-item docentes"><strong>Docente(s):</strong>
            <div *ngIf="producto.docentes && producto.docentes.length > 0; else noDocentesInyeccion" class="docentes-list">
              <span *ngFor="let docente of producto.docentes" class="docente-tag-small">
                <strong *ngIf="docente.especialidad">{{ docente.especialidad }}:</strong> {{ docente.nombre_completo }}
              </span>
            </div>
            <ng-template #noDocentesInyeccion><span class="no-docentes-small">No asignados</span></ng-template>
          </div>
        </div>
        <div class="course-card-footer">
          <button class="icon-btn-card edit" (click)="editCourse(producto); $event.stopPropagation()" title="Editar">‚úèÔ∏è</button>
          <button class="icon-btn-card delete" (click)="deleteCourse(producto.id); $event.stopPropagation()" title="Eliminar">üóëÔ∏è</button>
        </div>
      </div>
    </div>
    
    <div *ngIf="inyecciones.length === 0" class="no-data-card">
      {{ searchTerm ? 'No se encontraron inyecciones.' : 'No hay inyecciones registradas.' }}
    </div>
  </div>

  <!-- ========================================= -->
  <!-- MODAL: DETALLES DEL PRODUCTO -->
  <!-- ========================================= -->
  <div *ngIf="selectedCourse" class="modal-overlay" (click)="unselectCourse()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>Detalles de: {{ selectedCourse.nombre }}</h2>
        <button class="close-btn" (click)="unselectCourse()">‚úñ</button>
      </div>

      <div class="modal-body">
        <div class="scrollable-content">

          <div class="modal-section">
            <h4>Inscripci√≥n de Participantes</h4>
            <div class="add-participant-section">
              <button class="primary-btn small-btn" (click)="showAddParticipantForm = !showAddParticipantForm">Inscribir Manualmente</button>
              <div *ngIf="showAddParticipantForm" class="form-card nested-form">
                <form (ngSubmit)="enrollParticipant()">

                  <div class="form-group">
                    <label for="participant-select">Seleccionar Participante</label>
                    <select id="participant-select" [(ngModel)]="participantToAdd" name="participant_id" required autocomplete="off">
                      <option [ngValue]="null" disabled>-- Elige un participante --</option>
                      <option *ngFor="let p of availableParticipants" [value]="p.id">{{ p.nombre_completo }} ({{p.email_personal}})</option>
                    </select>
                  </div>

                  <div class="form-actions">
                    <button type="button" class="secondary-btn small-btn" (click)="showAddParticipantForm = false">Cancelar</button>
                    <button type="submit" class="primary-btn small-btn" [disabled]="!participantToAdd">Inscribir</button>
                  </div>
                </form>
              </div>
            </div>
            <div class="upload-section">
              <button class="secondary-btn small-btn" (click)="downloadTemplate()">Descargar Plantilla</button>

              <input id="file-upload" name="file-upload" type="file" (change)="onFileSelected($event)" accept=".csv, .xlsx" #fileInput hidden>
              <button class="secondary-btn small-btn" (click)="fileInput.click()">Importar desde Archivo</button>

              <span *ngIf="selectedFile">{{ selectedFile.name }}</span>
              <button class="primary-btn small-btn" (click)="uploadParticipants()" [disabled]="!selectedFile">Subir Archivo</button>
            </div>
          </div>

          <div class="data-table" *ngIf="selectedCourse.docentes && selectedCourse.docentes.length > 0">
            <h3 class="table-title">Docentes / Ponentes</h3>
            <table>
              <thead>
                <tr>
                  <th *ngIf="selectedCourse.tipo_producto === 'CURSO_EDUCATIVO'" class="checkbox-col">
                    <input type="checkbox"
                           [checked]="areAllDocenteRecipientsSelected"
                           (change)="toggleAllDocenteRecipients($event)"
                           title="Seleccionar Todos los Docentes">
                  </th>
                  <th>Nombre del Ponente</th>
                  <th>Email Institucional</th>
                  <th>WhatsApp</th>
                  <th>Constancia</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let docente of selectedCourse.docentes; trackBy: trackByDocenteId">
                  <td *ngIf="selectedCourse.tipo_producto === 'CURSO_EDUCATIVO'" class="checkbox-col">
                    <input type="checkbox"
                           [checked]="isDocenteRecipientSelected(docente.id)"
                           (change)="toggleDocenteCompetencyRecipient(docente.id, $event)">
                  </td>
                  <td>
                    <strong *ngIf="docente.especialidad" style="color: #667eea; display: block; font-size: 0.9em;">{{ docente.especialidad }}</strong>
                    {{ docente.nombre_completo }}
                  </td>
                  <td>{{ docente.email_institucional || 'N/A' }}</td>
                  <td>{{ docente.telefono || 'N/A' }}</td>
                  <td>
                    <ng-container *ngIf="getCertificadoForDocente(docente.id) as cert; else noConstanciaDocente">
                      <span class="serial-tag folio-normal">
                        {{ cert.folio }}
                        <button class="icon-btn delete small-btn" (click)="eliminarCertificado(cert.id)" title="Eliminar Constancia Docente">‚úñÔ∏è</button>
                      </span>
                    </ng-container>
                    <ng-template #noConstanciaDocente>
                      <span class="no-docentes-small">No emitida</span>
                    </ng-template>
                  </td>
                  <td class="actions-cell">
                    <div class="actions-content">
                      <ng-container *ngIf="getCertificadoForDocente(docente.id) as cert; else emitirConstanciaDocente">
                        <button 
                            class="icon-btn whatsapp" 
                            (click)="generateIndividualWhatsappLink(docente.whatsapp, selectedCourse.nombre); $event.stopPropagation()" 
                            title="Notificar por WhatsApp">
                            <span style="font-size: 1.2em;">üîî</span> 
                        </button>
                        <button class="icon-btn email" (click)="enviarConstanciaDocente(cert.id, docente.id)" title="Reenviar Constancia">üìß</button>
                      </ng-container>
                      <ng-template #emitirConstanciaDocente>
                        <div class="send-actions">
                          <button class="secondary-btn small-btn" (click)="issueDocenteCertificate(docente.id)">Emitir</button>
                        </div>
                      </ng-template>
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

          <div class="data-table">
            <h3 class="table-title">Participantes Inscritos ({{ inscripcionesDelProducto.length }})</h3>
            <table>
              <thead>
                <tr>
                  <th *ngIf="selectedCourse.tipo_producto === 'CURSO_EDUCATIVO'" class="checkbox-col">
                    <input type="checkbox"
                           [checked]="areAllCompetencyRecipientsSelected"
                           (change)="toggleAllCompetencyRecipients($event)"
                           title="Seleccionar Todos">
                  </th>
                  <th>Nombre</th>
                  <th>Email Personal</th>
                  <th>WhatsApp</th>
                  <th>Constancia (Normal)</th>
                  <th *ngIf="selectedCourse.tipo_producto === 'CURSO_EDUCATIVO'">Constancia (Comp.)</th>
                  <th>Acciones (Normal)</th>
                  <th *ngIf="selectedCourse.tipo_producto === 'CURSO_EDUCATIVO'">Acciones (Comp.)</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let inscripcion of inscripcionesDelProducto">
                  <td *ngIf="selectedCourse.tipo_producto === 'CURSO_EDUCATIVO'" class="checkbox-col">
                    <input type="checkbox"
                           [checked]="isRecipientSelected(inscripcion.participante.id)"
                           (change)="toggleCompetencyRecipient(inscripcion.participante.id, $event)">
                  </td>

                  <td>{{ inscripcion.participante.nombre_completo }}</td>
                  <td>{{ inscripcion.participante.email_personal }}</td>
                  <td>{{ inscripcion.participante.telefono || 'N/A' }}</td>

                  <td>
                    <ng-container *ngIf="getCertificadoForInscripcion(inscripcion.id) as certNormal; else noCertNormal">
                      <span class="serial-tag folio-normal">
                        {{ certNormal.folio }}
                        <button class="icon-btn delete small-btn"
                                (click)="eliminarCertificado(certNormal.id)"
                                title="Eliminar Constancia Normal">‚úñÔ∏è</button>
                      </span>
                    </ng-container>
                    <ng-template #noCertNormal><span class="no-docentes-small">No emitida</span></ng-template>
                  </td>

                  <td *ngIf="selectedCourse.tipo_producto === 'CURSO_EDUCATIVO'">
                    <ng-container *ngIf="getCertificadoCompetenciasForInscripcion(inscripcion.id) as certComp; else noCertComp">
                      <span class="serial-tag folio-competencias">
                        {{ certComp.folio }}
                        <button class="icon-btn delete small-btn"
                                (click)="eliminarCertificado(certComp.id)"
                                title="Eliminar Reconocimiento Competencias">‚ùå</button>
                      </span>
                    </ng-container>
                    <ng-template #noCertComp><span class="no-docentes-small">No emitida</span></ng-template>
                  </td>
                  <td class="actions-cell">
                    <div class="actions-content">
                      <button class="icon-btn delete" (click)="removeParticipantFromCourse(inscripcion.id)" title="Eliminar Inscripci√≥n">üóëÔ∏è</button>
                      
                      <ng-container *ngIf="getCertificadoForInscripcion(inscripcion.id) as certNormal; else emitirConstanciaNormal">
                          <button 
                              class="icon-btn whatsapp" 
                              (click)="generateIndividualWhatsappLink(inscripcion.participante.whatsapp, selectedCourse.nombre); $event.stopPropagation()" 
                              title="Notificar por WhatsApp">
                              <span style="font-size: 1.2em;">üîî</span>
                          </button>
                          <button class="icon-btn email" (click)="sendCertificate(certNormal.id)" title="Reenviar Constancia Normal">üìß</button>
                      </ng-container>
                      <ng-template #emitirConstanciaNormal>
                        <button class="secondary-btn small-btn" (click)="issueCertificate(inscripcion.id, false)">Emitir Normal</button>
                      </ng-template>
                    </div>
                  </td>
                  <td *ngIf="selectedCourse.tipo_producto === 'CURSO_EDUCATIVO'" class="actions-cell">
                    <div class="actions-content">
                      <ng-container *ngIf="getCertificadoCompetenciasForInscripcion(inscripcion.id) as certComp; else emitirConstanciaComp">
                          <button 
                              class="icon-btn whatsapp" 
                              (click)="generateIndividualWhatsappLink(inscripcion.participante.whatsapp, selectedCourse.nombre); $event.stopPropagation()" 
                              title="Notificar por WhatsApp">
                              <span style="font-size: 1.2em;">üîî</span>
                          </button>
                          <button class="icon-btn email email-competencias"
                                  (click)="sendCertificate(certComp.id)" 
                                  title="Reenviar Reconocimiento Competencias">üìß</button>
                      </ng-container>
                      <ng-template #emitirConstanciaComp>
                        <button class="secondary-btn small-btn btn-competencias"
                                (click)="issueCertificate(inscripcion.id, true)">Emitir Comp.</button>
                      </ng-template>
                    </div>
                  </td>
                </tr>
                <tr *ngIf="inscripcionesDelProducto.length === 0">
                  <td [attr.colspan]="selectedCourse.tipo_producto === 'CURSO_EDUCATIVO' ? 8 : 6" class="no-data">No hay participantes inscritos.</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="secondary-btn" (click)="unselectCourse()">Cerrar</button>
        <button
          type="button"
          class="primary-btn"
          (click)="emitAndSendCertificates()">
          Env√≠o Masivo (Normal)
        </button>
        <button
          type="button"
          class="primary-btn"
          *ngIf="selectedCourse.tipo_producto === 'CURSO_EDUCATIVO'"
          (click)="emitAndSendCompetenciesSelected()"
          [disabled]="competencyRecipients.size === 0">
          Emitir y Enviar Competencias ({{ competencyRecipients.size }} seleccionados)
        </button>
      </div>
    </div>
  </div>

  <!-- ========================================= -->
  <!-- MODAL: GESTIONAR COMPETENCIAS -->
  <!-- ========================================= -->
  <div *ngIf="showCompetenciesModal" class="modal-overlay" (click)="showCompetenciesModal = false">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>Gestionar Competencias</h2>
        <button class="close-btn" (click)="showCompetenciesModal = false">‚úñ</button>
      </div>
      <div class="modal-body">
        <p class="modal-instructions">A√±ade cada competencia en una l√≠nea separada.</p>
        <div class="competency-list">
          <div class="competency-item" *ngFor="let competency of competenciesList; let i = index; trackBy: trackByIndex">
            <label [for]="'competencia-' + i" class="visually-hidden">Competencia {{i + 1}}</label>
            <textarea [id]="'competencia-' + i" [name]="'competencia-' + i" [(ngModel)]="competenciesList[i]" placeholder="Escribe una competencia..." class="competency-input" rows="2"></textarea>
            <button *ngIf="competenciesList.length > 1" type="button" class="icon-btn delete small-btn" (click)="removeCompetency(i)" title="Eliminar">üóëÔ∏è</button>
          </div>
        </div>
        <button type="button" class="secondary-btn small-btn" (click)="addCompetency()">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
          A√±adir competencia
        </button>
      </div>
      <div class="modal-footer">
        <button type="button" class="secondary-btn" (click)="showCompetenciesModal = false">Cancelar</button>
        <button type="button" class="primary-btn" (click)="saveCompetencies()">Guardar Competencias</button>
      </div>
    </div>
  </div>

</div>