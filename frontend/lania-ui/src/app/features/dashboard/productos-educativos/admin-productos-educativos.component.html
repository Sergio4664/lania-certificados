<div class="module-content">
  <div class="module-header">
    <h2>Gesti√≥n de Productos Educativos</h2>
    <div class="header-actions">
      <div class="search-container">
        <input type="text" [(ngModel)]="searchTerm" (input)="groupAndFilterProducts()" placeholder="Buscar por nombre...">
        <svg class="search-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="11" cy="11" r="8"></circle>
          <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
        </svg>
      </div>
      <button class="primary-btn" (click)="showCourseForm = true; editingCourse = null; resetCourseForm()">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
        Nuevo Producto Educativo
      </button>
    </div>
  </div>

  <div *ngIf="showCourseForm" class="form-card">
    <h3>{{ editingCourse ? 'Editar el Producto Educativo' : 'Crear Nuevo Producto Educativo' }}</h3>
    <form [formGroup]="courseForm" (ngSubmit)="onSubmitCourse()" class="form-grid">
      <div class="form-group">
        <label>Nombre del Producto</label>
        <input formControlName="nombre" required>
      </div>
      <div class="form-group">
        <label>Horas</label>
        <input type="number" formControlName="horas" required>
      </div>
      <div class="form-group">
        <label>Fecha de Inicio</label>
        <input type="date" formControlName="fecha_inicio" required>
      </div>
      <div class="form-group">
        <label>Fecha de Fin</label>
        <input type="date" formControlName="fecha_fin" required>
      </div>
      <div class="form-group">
        <label>Tipo de Producto</label>
        <select formControlName="tipo_producto" required>
          <option value="CURSO_EDUCATIVO">Curso Educativo</option>
          <option value="PILDORA_EDUCATIVA">P√≠ldora Educativa</option>
          <option value="INYECCION_EDUCATIVA">Inyecci√≥n Educativa</option>
        </select>
      </div>
      <div class="form-group">
        <label>Modalidad</label>
        <select formControlName="modalidad" required>
            <option value="PRESENCIAL">Presencial</option>
            <option value="REMOTA">Remota</option>
            <option value="HIBRIDA">H√≠brida</option>
            <option value="SABATINA">Sabatina</option>
            <option value="ESCOLARIZADA">Escolarizada</option>
        </select>
      </div>
      <div class="form-group full-width">
        <label>Docentes Asignados</label>
        <div class="docentes-selection">
          <div class="docentes-checkboxes">
              <div class="checkbox-item" *ngFor="let docente of docentes">
                <input type="checkbox" [id]="'docente-' + docente.id" [checked]="courseForm.value.docente_ids.includes(docente.id)" (change)="toggleDocenteSelection(docente.id, $event)">
                <label [for]="'docente-' + docente.id">
                  <strong *ngIf="docente.especialidad" style="color: #667eea; display: block; font-size: 0.9em; margin-bottom: 2px;">{{docente.especialidad}}</strong>
                    {{docente.nombre_completo}}
                  <small>({{docente.email_institucional}})</small>
                </label>
              </div>
          </div>
        </div>
      </div>
      <div class="form-actions">
        <button type="button" class="secondary-btn" (click)="cancelCourseForm()">Cancelar</button>
        <button type="submit" class="primary-btn" [disabled]="courseForm.invalid">{{ editingCourse ? 'Actualizar Producto' : 'Crear Producto' }}</button>
      </div>
    </form>
  </div>

  <div class="product-section">
    <h3 class="section-title">Cursos Educativos</h3>
    <div class="courses-grid">
      <div class="course-card" *ngFor="let producto of cursos" (click)="selectCourse(producto)">
        <div class="course-card-header" [style.backgroundColor]="getCourseColor(producto.id)">
          <h3 class="course-name">{{ producto.nombre }}</h3>
        </div>
        <div class="course-card-body">
          <div class="detail-item"><strong>Modalidad:</strong> {{ producto.modalidad | titlecase }}</div>
          <div class="detail-item"><strong>Fechas:</strong> {{ producto.fecha_inicio | date:'dd/MM/yy' }} - {{ producto.fecha_fin | date:'dd/MM/yy' }}</div>
          <div class="detail-item"><strong>Horas:</strong> {{ producto.horas }}h</div>
          <div class="detail-item docentes"><strong>Docente(s):</strong>
            <div *ngIf="producto.docentes && producto.docentes.length > 0; else noDocentes" class="docentes-list">
              <span *ngFor="let docente of producto.docentes" class="docente-tag-small">
                <strong *ngIf="docente.especialidad">{{ docente.especialidad }}:</strong> {{ docente.nombre_completo }}
              </span>
            </div>
            <ng-template #noDocentes><span class="no-docentes-small">No asignados</span></ng-template>
          </div>
        </div>
        <div class="course-card-footer">
          <button class="icon-btn-card edit" (click)="editCourse(producto); $event.stopPropagation()" title="Editar">‚úèÔ∏è</button>
          <button class="icon-btn-card delete" (click)="deleteCourse(producto.id); $event.stopPropagation()" title="Eliminar">üóëÔ∏è</button>
        </div>
      </div>
    </div>
    <div *ngIf="!cursos || cursos.length === 0" class="no-data-card">
      {{ searchTerm ? 'No se encontraron cursos que coincidan.' : 'No hay cursos registrados.' }}
    </div>
  </div>
  
  <div class="product-section">
    <h3 class="section-title">P√≠ldoras Educativas</h3>
     </div>
  
   <div class="product-section">
    <h3 class="section-title">Inyecciones Educativas</h3>
     </div>

  <div *ngIf="selectedCourse" class="modal-overlay" (click)="unselectCourse()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>Detalles de: {{ selectedCourse.nombre }}</h2>
        <button class="close-btn" (click)="unselectCourse()">‚úñ</button>
      </div>
      <div class="modal-body">
        
        <div *ngIf="selectedCourse.docentes?.length > 0" class="data-table">
            <div class="table-header">
                <h3 class="table-title">Docentes Asignados ({{ selectedCourse.docentes.length }})</h3>
                <div>
                  <button class="btn-success small-btn" (click)="emitirTodas('docentes')">Emitir Todas</button>
                  <button class="btn-info small-btn" (click)="enviarTodas('docentes')">Enviar Todas</button>
                </div>
            </div>
            <table>
              <thead>
                <tr>
                  <th>Nombre</th>
                  <th>Estado Constancia</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let docente of selectedCourse.docentes">
                  <td>{{ docente.nombre_completo }}</td>
                  <td>
                    <span *ngIf="getCertificadoForDocente(docente) as cert" class="serial-tag">{{ cert.folio }}</span>
                    <span *ngIf="!getCertificadoForDocente(docente)" class="no-docentes-small">No emitida</span>
                  </td>
                  <td class="actions-cell">
                    <ng-container *ngIf="getCertificadoForDocente(docente) as cert; else emitDocenteBtn">
                      <button class="icon-btn email" (click)="enviarConstancia(cert.id, 'docente')" title="Enviar por Correo">üìß</button>
                    </ng-container>
                    <ng-template #emitDocenteBtn>
                      <button class="secondary-btn small-btn" (click)="emitirConstancia(docente.id, 'docente')">Emitir</button>
                    </ng-template>
                  </td>
                </tr>
              </tbody>
            </table>
        </div>

        <div class="modal-section">
            <h4>Inscripci√≥n de Participantes</h4>
            <div class="add-participant-section">
              <button class="primary-btn small-btn" (click)="showAddParticipantForm = !showAddParticipantForm">Inscribir Manualmente</button>
              <div *ngIf="showAddParticipantForm" class="form-card nested-form">
                <form (ngSubmit)="enrollParticipant()">
                  <div class="form-group">
                    <label>Seleccionar Participante</label>
                    <select [(ngModel)]="participantToAdd" name="participant_id" required>
                      <option [ngValue]="null" disabled>-- Elige un participante --</option>
                      <option *ngFor="let p of availableParticipants" [value]="p.id">{{ p.nombre_completo }} ({{p.email_personal}})</option>
                    </select>
                  </div>
                  <div class="form-actions">
                    <button type="button" class="secondary-btn small-btn" (click)="showAddParticipantForm = false">Cancelar</button>
                    <button type="submit" class="primary-btn small-btn" [disabled]="!participantToAdd">Inscribir</button>
                  </div>
                </form>
              </div>
            </div>
            <div class="upload-section">
              <button class="secondary-btn small-btn" (click)="descargarPlantilla()">Descargar Plantilla</button>
              <input type="file" (change)="onFileSelected($event)" accept=".csv, .xlsx" #fileInput hidden>
              <button class="secondary-btn small-btn" (click)="fileInput.click()">Importar desde Archivo</button>
              <span *ngIf="selectedFile">{{ selectedFile.name }}</span>
              <button class="primary-btn small-btn" (click)="uploadParticipants()" [disabled]="!selectedFile">Subir Archivo</button>
            </div>
        </div>

        <div class="data-table">
            <div class="table-header">
                <h3 class="table-title">Participantes Inscritos ({{ getParticipantInscriptions().length }})</h3>
                <div>
                  <button class="btn-success small-btn" (click)="emitirTodas('participantes')">Emitir Todas</button>
                  <button class="btn-info small-btn" (click)="enviarTodas('participantes')">Enviar Todas</button>
                </div>
            </div>
          <table>
            <thead>
              <tr>
                <th>Nombre</th>
                <th>Estado Constancia</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let inscripcion of getParticipantInscriptions()">
                <td>{{ inscripcion.participante.nombre_completo }}</td>
                <td>
                  <span *ngIf="getCertificadoForInscripcion(inscripcion.id) as cert" class="serial-tag">{{ cert.folio }}</span>
                  <span *ngIf="!getCertificadoForInscripcion(inscripcion.id)" class="no-docentes-small">No emitida</span>
                </td>
                <td class="actions-cell">
                  <ng-container *ngIf="getCertificadoForInscripcion(inscripcion.id) as cert; else emitParticipanteBtn">
                    <button class="icon-btn email" (click)="enviarConstancia(cert.id, 'participante')" title="Enviar por Correo">üìß</button>
                  </ng-container>
                  <ng-template #emitParticipanteBtn>
                    <button class="secondary-btn small-btn" (click)="emitirConstancia(inscripcion.participante.id, 'participante')">Emitir</button>
                  </ng-template>
                   <button class="icon-btn delete" (click)="removeParticipantFromCourse(inscripcion.id)" title="Eliminar del curso">üóëÔ∏è</button>
                </td>
              </tr>
              <tr *ngIf="getParticipantInscriptions().length === 0">
                <td colspan="3" class="no-data">No hay participantes inscritos.</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
      <div class="modal-footer">
          <button type="button" class="secondary-btn" (click)="unselectCourse()">Cerrar</button>
      </div>
    </div>
  </div>
</div>