<div class="module-content">
  <div class="module-header">
    <h2>Gesti√≥n de Productos Educativos</h2>
    <div class="header-actions">
      <div class="search-container">
        <input type="text" [(ngModel)]="searchTerm" (input)="groupAndFilterProducts()" placeholder="Buscar por nombre...">
        <svg class="search-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="11" cy="11" r="8"></circle>
          <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
        </svg>
      </div>
      <button class="primary-btn" (click)="showCourseForm = true; editingCourse = null; resetCourseForm()">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
        Nuevo Producto Educativo
      </button>
    </div>
  </div>

  <div *ngIf="showCourseForm" class="form-card">
    <h3>{{ editingCourse ? 'Editar el Producto Educativo' : 'Crear Nuevo Producto Educativo' }}</h3>
    <form [formGroup]="courseForm" (ngSubmit)="onSubmitCourse()" class="form-grid">
      <div class="form-group">
        <label>Nombre del Producto</label>
        <input formControlName="nombre" required>
      </div>
      <div class="form-group">
        <label>Horas</label>
        <input type="number" formControlName="horas" required>
      </div>
      <div class="form-group">
        <label>Fecha de Inicio</label>
        <input type="date" formControlName="fecha_inicio" required>
      </div>
      <div class="form-group">
        <label>Fecha de Fin</label>
        <input type="date" formControlName="fecha_fin" required>
      </div>
      <div *ngIf="courseForm.hasError('dateRangeInvalid') && (courseForm.get('fecha_fin')?.touched || courseForm.get('fecha_inicio')?.touched)" class="form-error full-width">
        <p>Error: La fecha de finalizaci√≥n no puede ser anterior a la fecha de inicio.</p>
      </div>
      <div class="form-group">
        <label>Tipo de Producto</label>
        <select formControlName="tipo_producto" required>
          <option value="CURSO_EDUCATIVO">Curso Educativo</option>
          <option value="PILDORA_EDUCATIVA">P√≠ldora Educativa</option>
          <option value="INYECCION_EDUCATIVA">Inyecci√≥n Educativa</option>
        </select>
      </div>
      <div class="form-group">
        <label>Modalidad</label>
        <select formControlName="modalidad" required>
            <option value="PRESENCIAL">Presencial</option>
            <option value="REMOTA">Remota</option>
            <option value="HIBRIDA">H√≠brida</option>
            <option value="SABATINA">Sabatina</option>
            <option value="ESCOLARIZADA">Escolarizada</option>
        </select>
      </div>
      <div class="form-group full-width" *ngIf="courseForm.get('tipo_producto')?.value === 'CURSO_EDUCATIVO'">
        <label>Competencias del Curso</label>
        <button type="button" class="secondary-btn icon-left" (click)="openCompetenciesModal()">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
          {{ courseForm.get('competencias')?.value ? 'Editar Competencias' : 'A√±adir Competencias' }}
        </button>
      </div>
      <div class="form-group full-width">
        <label>Docentes Asignados</label>
        <div class="docentes-selection">
          <div class="docentes-checkboxes">
              <div class="checkbox-item" *ngFor="let docente of docentes">
                <input type="checkbox" [id]="'docente-' + docente.id" [checked]="courseForm.value.docente_ids?.includes(docente.id)" (change)="toggleDocenteSelection(docente.id, $event)">
                <label [for]="'docente-' + docente.id">
                  <strong *ngIf="docente.especialidad" style="color: #667eea; display: block; font-size: 0.9em; margin-bottom: 2px;">{{docente.especialidad}}</strong>
                    {{docente.nombre_completo}}
                  <small>({{docente.email_institucional}})</small>
                </label>
              </div>
          </div>
        </div>
      </div>
      <div class="form-actions">
        <button type="button" class="secondary-btn" (click)="cancelCourseForm()">Cancelar</button>
        <button type="submit" class="primary-btn" [disabled]="courseForm.invalid">{{ editingCourse ? 'Actualizar Producto' : 'Crear Producto' }}</button>
      </div>
    </form>
  </div>

  <div class="product-section">
      <h3 class="section-title">Cursos Educativos</h3>
      <div class="courses-grid">
        <div class="course-card" *ngFor="let producto of cursos" (click)="selectCourse(producto)">
          <div class="course-card-header" [style.backgroundColor]="getCourseColor(producto.id)">
            <h3 class="course-name">{{ producto.nombre }}</h3>
          </div>
          <div class="course-card-body">
            <div class="detail-item"><strong>Modalidad:</strong> {{ producto.modalidad || 'N/A' }}</div>
            <div class="detail-item"><strong>Fechas:</strong> {{ producto.fecha_inicio | date:'dd/MM/yy' }} - {{ producto.fecha_fin | date:'dd/MM/yy' }}</div>
            <div class="detail-item"><strong>Horas:</strong> {{ producto.horas }}h</div>
            <div class="detail-item docentes"><strong>Docente(s):</strong>
              <div *ngIf="producto.docentes && producto.docentes.length > 0; else noDocentes" class="docentes-list">
                <span *ngFor="let docente of producto.docentes" class="docente-tag-small">
                  <strong *ngIf="docente.especialidad">{{ docente.especialidad }}:</strong> {{ docente.nombre_completo }}
                </span>
              </div>
              <ng-template #noDocentes><span class="no-docentes-small">No asignados</span></ng-template>
            </div>
          </div>
          <div class="course-card-footer">
            <button class="icon-btn-card edit" (click)="editCourse(producto); $event.stopPropagation()" title="Editar">‚úèÔ∏è</button>
            <button class="icon-btn-card delete" (click)="deleteCourse(producto.id); $event.stopPropagation()" title="Eliminar">üóëÔ∏è</button>
          </div>
        </div>
      </div>
      <div *ngIf="cursos.length === 0" class="no-data-card">
        {{ searchTerm ? 'No se encontraron cursos que coincidan con la b√∫squeda.' : 'No hay cursos registrados.' }}
      </div>
  </div>
  <div class="product-section">
      <h3 class="section-title">P√≠ldoras Educativas</h3>
      <div class="courses-grid">
        <div class="course-card" *ngFor="let producto of pildoras" (click)="selectCourse(producto)">
            <div class="course-card-header" [style.backgroundColor]="getCourseColor(producto.id)">
                <h3 class="course-name">{{ producto.nombre }}</h3>
            </div>
            <div class="course-card-body">
              <div class="detail-item"><strong>Modalidad:</strong> {{ producto.modalidad || 'N/A' }}</div>
              <div class="detail-item"><strong>Fechas:</strong> {{ producto.fecha_inicio | date:'dd/MM/yy' }} - {{ producto.fecha_fin | date:'dd/MM/yy' }}</div>
              <div class="detail-item"><strong>Horas:</strong> {{ producto.horas }}h</div>
              <div class="detail-item docentes"><strong>Docente(s):</strong>
                <div *ngIf="producto.docentes && producto.docentes.length > 0; else noDocentes" class="docentes-list">
                    <span *ngFor="let docente of producto.docentes" class="docente-tag-small">
                      <strong *ngIf="docente.especialidad">{{ docente.especialidad }}:</strong> {{ docente.nombre_completo }}
                    </span>
                </div>
                <ng-template #noDocentes><span class="no-docentes-small">No asignados</span></ng-template>
              </div>
            </div>
            <div class="course-card-footer">
              <button class="icon-btn-card edit" (click)="editCourse(producto); $event.stopPropagation()" title="Editar">‚úèÔ∏è</button>
              <button class="icon-btn-card delete" (click)="deleteCourse(producto.id); $event.stopPropagation()" title="Eliminar">üóëÔ∏è</button>
            </div>
        </div>
      </div>
      <div *ngIf="pildoras.length === 0" class="no-data-card">
        {{ searchTerm ? 'No se encontraron p√≠ldoras.' : 'No hay p√≠ldoras registradas.' }}
      </div>
  </div>
  <div class="product-section">
      <h3 class="section-title">Inyecciones Educativas</h3>
      <div class="courses-grid">
        <div class="course-card" *ngFor="let producto of inyecciones" (click)="selectCourse(producto)">
            <div class="course-card-header" [style.backgroundColor]="getCourseColor(producto.id)">
                <h3 class="course-name">{{ producto.nombre }}</h3>
            </div>
            <div class="course-card-body">
              <div class="detail-item"><strong>Modalidad:</strong> {{ producto.modalidad || 'N/A' }}</div>
              <div class="detail-item"><strong>Fechas:</strong> {{ producto.fecha_inicio | date:'dd/MM/yy' }} - {{ producto.fecha_fin | date:'dd/MM/yy' }}</div>
              <div class="detail-item"><strong>Horas:</strong> {{ producto.horas }}h</div>
              <div class="detail-item docentes"><strong>Docente(s):</strong>
                <div *ngIf="producto.docentes && producto.docentes.length > 0; else noDocentes" class="docentes-list">
                    <span *ngFor="let docente of producto.docentes" class="docente-tag-small">
                      <strong *ngIf="docente.especialidad">{{ docente.especialidad }}:</strong> {{ docente.nombre_completo }}
                    </span>
                </div>
                <ng-template #noDocentes><span class="no-docentes-small">No asignados</span></ng-template>
              </div>
            </div>
            <div class="course-card-footer">
              <button class="icon-btn-card edit" (click)="editCourse(producto); $event.stopPropagation()" title="Editar">‚úèÔ∏è</button>
              <button class="icon-btn-card delete" (click)="deleteCourse(producto.id); $event.stopPropagation()" title="Eliminar">üóëÔ∏è</button>
            </div>
        </div>
      </div>
      <div *ngIf="inyecciones.length === 0" class="no-data-card">
          {{ searchTerm ? 'No se encontraron inyecciones.' : 'No hay inyecciones registradas.' }}
      </div>
  </div>

  <div *ngIf="selectedCourse" class="modal-overlay" (click)="unselectCourse()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>Detalles de: {{ selectedCourse.nombre }}</h2>
        <button class="close-btn" (click)="unselectCourse()">‚úñ</button>
      </div>

      <div class="modal-body">
        <div class="scrollable-content">

          <div class="modal-section">
              <h4>Inscripci√≥n de Participantes</h4>
              <div class="add-participant-section">
                <button class="primary-btn small-btn" (click)="showAddParticipantForm = !showAddParticipantForm">Inscribir Manualmente</button>
                <div *ngIf="showAddParticipantForm" class="form-card nested-form">
                  <form (ngSubmit)="enrollParticipant()">
                    <div class="form-group">
                      <label>Seleccionar Participante</label>
                      <select [(ngModel)]="participantToAdd" name="participant_id" required>
                        <option [ngValue]="null" disabled>-- Elige un participante --</option>
                        <option *ngFor="let p of availableParticipants" [value]="p.id">{{ p.nombre_completo }} ({{p.email_personal}})</option>
                      </select>
                    </div>
                    <div class="form-actions">
                      <button type="button" class="secondary-btn small-btn" (click)="showAddParticipantForm = false">Cancelar</button>
                      <button type="submit" class="primary-btn small-btn" [disabled]="!participantToAdd">Inscribir</button>
                    </div>
                  </form>
                </div>
              </div>
              <div class="upload-section">
                <button class="secondary-btn small-btn" (click)="descargarPlantilla()">Descargar Plantilla</button>
                <input type="file" (change)="onFileSelected($event)" accept=".csv, .xlsx" #fileInput hidden>
                <button class="secondary-btn small-btn" (click)="fileInput.click()">Importar desde Archivo</button>
                <span *ngIf="selectedFile">{{ selectedFile.name }}</span>
                <button class="primary-btn small-btn" (click)="uploadParticipants()" [disabled]="!selectedFile">Subir Archivo</button>
              </div>
          </div>

          <div class="data-table" *ngIf="selectedCourse.docentes && selectedCourse.docentes.length > 0">
              <h3 class="table-title">Docentes / Ponentes</h3>
              <table>
                <thead>
                  <tr>
                    <th *ngIf="selectedCourse.tipo_producto === 'CURSO_EDUCATIVO'" class="checkbox-col">
                      <input type="checkbox"
                            [checked]="areAllDocenteRecipientsSelected"
                            (change)="toggleAllDocenteRecipients($event)"
                            title="Seleccionar Todos los Docentes">
                    </th>
                    <th>Nombre del Ponente</th>
                    <th>Email Institucional</th>
                    <th>WhatsApp</th>
                    <th>Constancia</th>
                    <th>Acciones</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let docente of selectedCourse.docentes; trackBy: trackByDocenteId">
                    <td *ngIf="selectedCourse.tipo_producto === 'CURSO_EDUCATIVO'" class="checkbox-col">
                      <input type="checkbox"
                            [checked]="isDocenteRecipientSelected(docente.id)"
                            (change)="toggleDocenteCompetencyRecipient(docente.id, $event)">
                    </td>
                    <td>
                      <strong *ngIf="docente.especialidad" style="color: #667eea; display: block; font-size: 0.9em;">{{ docente.especialidad }}</strong>
                      {{ docente.nombre_completo }}
                    </td>
                    <td>{{ docente.email_institucional || 'N/A' }}</td>
                    <td>{{ docente.telefono || 'N/A' }}</td>
                    <td>
                      <ng-container *ngIf="getCertificadoForDocente(docente.id) as cert; else noConstanciaDocente">
                        <span class="serial-tag">{{ cert.folio }}</span>
                      </ng-container>
                      <ng-template #noConstanciaDocente>
                        <span class="no-docentes-small">No emitida</span>
                      </ng-template>
                    </td>
                    <td class="actions-cell">
                      <ng-container *ngIf="getCertificadoForDocente(docente.id) as cert; else emitirConstanciaDocente">
                        <button class="icon-btn email" (click)="enviarConstanciaDocente(cert.id, docente.id)" title="Reenviar Constancia">üìß</button>
                        <button class="icon-btn delete" (click)="eliminarCertificado(cert.id)" title="Eliminar Constancia">‚úñÔ∏è</button>
                      </ng-container>
                      <ng-template #emitirConstanciaDocente>
                        <div class="send-actions">
                          <button class="secondary-btn small-btn" (click)="issueDocenteCertificate(docente.id, false)">Emitir</button>
                        </div>
                      </ng-template>
                    </td>
                  </tr>
                </tbody>
              </table>
          </div>

          <div class="data-table">
            <h3 class="table-title">Participantes Inscritos ({{ inscripcionesDelProducto.length }})</h3>
            <table>
              <thead>
                <tr>
                  <th *ngIf="selectedCourse.tipo_producto === 'CURSO_EDUCATIVO'" class="checkbox-col">
                    <input type="checkbox"
                          [checked]="areAllCompetencyRecipientsSelected"
                          (change)="toggleAllCompetencyRecipients($event)"
                          title="Seleccionar Todos">
                  </th>
                  <th>Nombre</th>
                  <th>Email Personal</th>
                  <th>WhatsApp</th>
                  <th>Constancia</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let inscripcion of inscripcionesDelProducto">
                  <td *ngIf="selectedCourse.tipo_producto === 'CURSO_EDUCATIVO'" class="checkbox-col">
                    <input type="checkbox"
                          [checked]="isRecipientSelected(inscripcion.participante.id)"
                          (change)="toggleCompetencyRecipient(inscripcion.participante.id, $event)">
                  </td>
                  <td>{{ inscripcion.participante.nombre_completo }}</td>
                  <td>{{ inscripcion.participante.email_personal }}</td>
                  <td>{{ inscripcion.participante.telefono || 'N/A' }}</td>
                  <td>
                    <ng-container *ngIf="getCertificadoForInscripcion(inscripcion.id) as cert; else noCert">
                      <span class="serial-tag">{{ cert.folio }}</span>
                    </ng-container>
                    <ng-template #noCert><span class="no-docentes-small">No emitida</span></ng-template>
                  </td>
                  <td class="actions-cell">
                      <button class="icon-btn delete" (click)="removeParticipantFromCourse(inscripcion.id)" title="Eliminar del curso">üóëÔ∏è</button>

                      <ng-container *ngIf="getCertificadoForInscripcion(inscripcion.id) as cert; else emitirConstanciaParticipante">
                        <button class="icon-btn email" (click)="sendCertificate(cert.id)" title="Reenviar por Correo">üìß</button>
                        <button class="icon-btn delete" (click)="eliminarCertificado(cert.id)" title="Eliminar Constancia">‚úñÔ∏è</button>
                      </ng-container>
                      <ng-template #emitirConstanciaParticipante>
                        <div class="send-actions">
                          <button class="secondary-btn small-btn" (click)="issueCertificate(inscripcion.id, false)">Normal</button>
                          <button *ngIf="selectedCourse.tipo_producto === 'CURSO_EDUCATIVO'" class="primary-btn small-btn" (click)="issueCertificate(inscripcion.id, true)">Competencias</button>
                        </div>
                      </ng-template>
                  </td>
                </tr>
                <tr *ngIf="inscripcionesDelProducto.length === 0">
                  <td [attr.colspan]="selectedCourse.tipo_producto === 'CURSO_EDUCATIVO' ? 6 : 5" class="no-data">No hay participantes inscritos.</td>
                </tr>
              </tbody>
            </table>
          </div>

        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="secondary-btn" (click)="unselectCourse()">Cerrar</button>
        <button type="button" class="primary-btn" (click)="emitAndSendCertificates()">Emisi√≥n y Env√≠o Masivo</button>
      </div>
    </div>
  </div>

  <div *ngIf="showCompetenciesModal" class="modal-overlay" (click)="showCompetenciesModal = false">
      <div class="modal-content" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h2>Gestionar Competencias</h2>
          <button class="close-btn" (click)="showCompetenciesModal = false">‚úñ</button>
        </div>
        <div class="modal-body">
          <p class="modal-instructions">A√±ade cada competencia en una l√≠nea separada.</p>
          <div class="competency-list">
            <div class="competency-item" *ngFor="let competency of competenciesList; let i = index; trackBy: trackByIndex">
              <textarea [(ngModel)]="competenciesList[i]" placeholder="Escribe una competencia..." class="competency-input" rows="2"></textarea>
              <button *ngIf="competenciesList.length > 1" type="button" class="icon-btn delete small-btn" (click)="removeCompetency(i)" title="Eliminar">üóëÔ∏è</button>
            </div>
          </div>
          <button type="button" class="secondary-btn small-btn" (click)="addCompetency()">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
            A√±adir competencia
          </button>
        </div>
        <div class="modal-footer">
          <button type="button" class="secondary-btn" (click)="showCompetenciesModal = false">Cancelar</button>
          <button type="button" class="primary-btn" (click)="saveCompetencies()">Guardar Competencias</button>
        </div>
      </div>
  </div>
</div>